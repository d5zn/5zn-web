<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="5zn-web - Activity Details">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' 'unsafe-hashes'; style-src * 'unsafe-inline'; img-src * data: blob:; connect-src *; object-src *; media-src *; font-src *; worker-src *; manifest-src *; form-action *; base-uri *;">
    <title>Activity - 5zn.io</title>
    <link rel="stylesheet" href="styles.css?v=56">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .activity-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .loading {
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .activity-content {
            max-width: 600px;
            width: 100%;
        }
        
        .activity-header {
            margin-bottom: 30px;
        }
        
        .activity-title {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .activity-date {
            font-size: 14px;
            color: #888;
        }
        
        .canvas-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 16;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #activity-canvas {
            display: block;
            vertical-align: middle;
            /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞–µ—Ç—Å—è –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ width/height */
            /* CSS —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º */
            max-width: 100%;
            max-height: 95%;
            margin: auto;
            /* –ö—Ä–∏—Ç–∏—á–Ω–æ: aspect-ratio –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ */
            aspect-ratio: 9 / 16;
            /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ */
            transition: height 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #111;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #222;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 300;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s;
        }
        
        .back-button:hover {
            opacity: 0.8;
        }
        
        .error-message {
            text-align: center;
            color: #ff4444;
            padding: 20px;
        }
        
        @media (max-width: 480px) {
            .activity-title {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="activity-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</p>
        </div>
        
        <div id="error" class="error-message hidden">
            <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
            <p id="error-text"></p>
            <button class="back-button" onclick="window.location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <div id="content" class="activity-content hidden">
            <div class="activity-header">
                <h1 class="activity-title" id="activity-title">Activity</h1>
                <p class="activity-date" id="activity-date"></p>
            </div>
            
            <div class="canvas-wrapper">
                <canvas id="activity-canvas"></canvas>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">DISTANCE</div>
                    <div class="stat-value" id="distance">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ELEVATION</div>
                    <div class="stat-value" id="elevation">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TIME</div>
                    <div class="stat-value" id="time">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">AVG SPEED</div>
                    <div class="stat-value" id="speed">‚Äî</div>
                </div>
            </div>
            
            <button class="back-button" onclick="window.location.href='/'">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
        </div>
    </div>

    <script src="polyline.js"></script>
    <script>
        class ActivityViewer {
            constructor() {
                this.canvas = document.getElementById('activity-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.stravaToken = localStorage.getItem('strava_token');
                this.activityId = this.getActivityIdFromURL();
                
                // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–∫–∞–∫ –≤ app.js)
                this.internalWidth = 1080;
                this.internalHeight = 1920;
                
                if (!this.activityId) {
                    this.showError('ID –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL');
                    return;
                }
                
                if (!this.stravaToken || this.stravaToken === 'YOUR_STRAVA_CLIENT_ID') {
                    this.showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Strava');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
                
                this.initCanvas();
                this.loadActivity();
            }
            
            getActivityIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('activityId');
            }
            
            initCanvas() {
                // –ü–æ–¥—Ö–æ–¥ –∫–∞–∫ –≤ app.js: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã + CSS –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                const rawDpr = window.devicePixelRatio || 1;
                const dpr = Math.min(rawDpr, 2);
                
                // Canvas —Ä–∏—Å—É–µ—Ç—Å—è –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
                this.canvas.width = this.internalWidth * dpr;
                this.canvas.height = this.internalHeight * dpr;
                
                // CSS —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 1080x1920 —á–µ—Ä–µ–∑ CSS)
                this.canvas.style.width = this.internalWidth + 'px';
                this.canvas.style.height = this.internalHeight + 'px';
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º DPR –º–∞—Å—à—Ç–∞–±
                this.ctx.scale(dpr, dpr);
                
                console.log('‚úÖ Canvas initialized:', this.canvas.width, 'x', this.canvas.height, 'at DPR', dpr);
                console.log('‚úÖ Canvas display size:', this.internalWidth, 'x', this.internalHeight);
            }
            
            async loadActivity() {
                try {
                    const response = await fetch(`https://www.strava.com/api/v3/activities/${this.activityId}`, {
                        headers: {
                            'Authorization': `Bearer ${this.stravaToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const activity = await response.json();
                    this.displayActivity(activity);
                } catch (error) {
                    console.error('Error loading activity:', error);
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å');
                }
            }
            
            displayActivity(activity) {
                console.log('üìä Displaying activity:', activity.name);
                console.log('üìä Activity data:', activity);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                document.getElementById('activity-title').textContent = activity.name || 'Activity';
                document.getElementById('activity-date').textContent = this.formatDate(activity.start_date);
                
                document.getElementById('distance').textContent = this.formatDistance(activity.distance);
                document.getElementById('elevation').textContent = this.formatElevation(activity.total_elevation_gain);
                document.getElementById('time').textContent = this.formatTime(activity.moving_time);
                document.getElementById('speed').textContent = this.formatSpeed(activity.average_speed);
                
                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                this.drawRoute(activity);
            }
            
            drawRoute(activity) {
                if (!this.ctx) return;
                
                console.log('üó∫Ô∏è Drawing route for activity:', activity.name);
                console.log('üó∫Ô∏è Map data:', activity.map);
                
                // –û—á–∏—â–∞–µ–º canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ–Ω
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
                const map = activity.map?.polyline || activity.map?.summary_polyline;
                
                console.log('üó∫Ô∏è Polyline data:', map ? `Found (${map.length} chars)` : 'Not found');
                
                if (!map) {
                    console.warn('‚ö†Ô∏è No polyline data found');
                    // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞, —Ä–∏—Å—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                    this.drawNoRouteMessage();
                    return;
                }
                
                const points = this.decodePolyline(map);
                console.log('üó∫Ô∏è Decoded points:', points ? points.length : 0);
                
                if (!points || points.length === 0) {
                    console.warn('‚ö†Ô∏è No points decoded');
                    this.drawNoRouteMessage();
                    return;
                }
                
                console.log('üó∫Ô∏è First 3 raw points:', points.slice(0, 3));
                
                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ —Ñ–ª–∞–≥–∞
                this.drawRouteWithGradient(points);
            }
            
            drawRouteWithGradient(points) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã (–¥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è DPR)
                const width = this.internalWidth;
                const height = this.internalHeight;
                
                console.log('üîç Drawing route with points:', points.length);
                console.log('üîç Canvas internal size:', width, 'x', height);
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∏ –º–∞—Å—à—Ç–∞–± –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
                const bounds = this.calculateBounds(points);
                console.log('üîç Bounds:', bounds);
                
                const scale = this.calculateScale(bounds, width - 100, height - 300);
                console.log('üîç Scale:', scale);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª–∏ canvas
                const canvasPoints = points.map(([lat, lng]) => {
                    const x = (lng - bounds.minLng) * scale + 50;
                    const y = (bounds.maxLat - lat) * scale + 100; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y
                    return { x, y };
                });
                
                console.log('üîç First 3 canvas points:', canvasPoints.slice(0, 3));
                console.log('üîç Last 3 canvas points:', canvasPoints.slice(-3));
                
                // –†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–≥–æ —Ñ–ª–∞–≥–∞
                this.ctx.lineWidth = 4;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –ª–∏–Ω–∏–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
                let minX = Math.min(...canvasPoints.map(p => p.x));
                let maxX = Math.max(...canvasPoints.map(p => p.x));
                
                console.log('üîç Gradient bounds:', { minX, maxX });
                
                // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
                const gradient = this.ctx.createLinearGradient(minX, 0, maxX, 0);
                gradient.addColorStop(0, '#002395');    // –°–∏–Ω–∏–π (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π —Å–∏–Ω–∏–π)
                gradient.addColorStop(0.4, '#FFFFFF');  // –ë–µ–ª—ã–π (–ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
                gradient.addColorStop(0.6, '#FFFFFF');  // –ë–µ–ª—ã–π (–ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥)
                gradient.addColorStop(1, '#ED2939');     // –ö—Ä–∞—Å–Ω—ã–π (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π)
                
                this.ctx.strokeStyle = gradient;
                
                // –†–∏—Å—É–µ–º –ø—É—Ç—å
                this.ctx.beginPath();
                let firstValidPoint = null;
                
                for (let i = 0; i < canvasPoints.length; i++) {
                    const point = canvasPoints[i];
                    if (!isNaN(point.x) && !isNaN(point.y) && isFinite(point.x) && isFinite(point.y)) {
                        if (firstValidPoint === null) {
                            firstValidPoint = point;
                            this.ctx.moveTo(point.x, point.y);
                        } else {
                            this.ctx.lineTo(point.x, point.y);
                        }
                    }
                }
                
                if (firstValidPoint === null) {
                    console.error('‚ùå No valid points to draw!');
                    this.drawNoRouteMessage();
                    return;
                }
                
                this.ctx.stroke();
                console.log('‚úÖ Route drawn successfully');
            }
            
            decodePolyline(encoded) {
                console.log('üîç Decoding polyline, length:', encoded?.length);
                console.log('üîç window.polyline exists:', typeof window.polyline);
                
                if (!encoded || encoded.length < 10) {
                    console.warn('‚ö†Ô∏è Invalid polyline data');
                    return null;
                }
                
                if (typeof window.polyline !== 'undefined' && window.polyline.decode) {
                    console.log('‚úÖ Using window.polyline.decode');
                    const decoded = window.polyline.decode(encoded);
                    console.log('‚úÖ Decoded', decoded.length, 'points');
                    return decoded;
                }
                
                console.log('‚ö†Ô∏è Using fallback decoder');
                
                // Fallback decoder - —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ app.js
                const coordinates = [];
                let index = 0;
                let lat = 0;
                let lng = 0;
                
                while (index < encoded.length) {
                    let shift = 0;
                    let result = 0;
                    let byte;
                    
                    do {
                        byte = encoded.charCodeAt(index++) - 63;
                        result |= (byte & 0x1f) << shift;
                        shift += 5;
                    } while (byte >= 0x20);
                    
                    const deltaLat = (result & 1) ? ~(result >> 1) : (result >> 1);
                    lat += deltaLat;
                    
                    shift = 0;
                    result = 0;
                    
                    do {
                        byte = encoded.charCodeAt(index++) - 63;
                        result |= (byte & 0x1f) << shift;
                        shift += 5;
                    } while (byte >= 0x20);
                    
                    const deltaLng = (result & 1) ? ~(result >> 1) : (result >> 1);
                    lng += deltaLng;
                    
                    // –§–æ—Ä–º–∞—Ç –∫–∞–∫ –≤ app.js: [lat, lng] (—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞)
                    coordinates.push([lat / 1e5, lng / 1e5]);
                }
                
                return coordinates;
            }
            
            calculateBounds(points) {
                let minLat = Infinity, maxLat = -Infinity;
                let minLng = Infinity, maxLng = -Infinity;
                
                for (const point of points) {
                    minLat = Math.min(minLat, point[0]);
                    maxLat = Math.max(maxLat, point[0]);
                    minLng = Math.min(minLng, point[1]);
                    maxLng = Math.max(maxLng, point[1]);
                }
                
                return { minLat, maxLat, minLng, maxLng };
            }
            
            calculateScale(bounds, width, height) {
                const latRange = bounds.maxLat - bounds.minLat;
                const lngRange = bounds.maxLng - bounds.minLng;
                
                const scaleX = width / lngRange;
                const scaleY = height / latRange;
                
                return Math.min(scaleX, scaleY);
            }
            
            drawNoRouteMessage() {
                this.ctx.fillStyle = '#333';
                this.ctx.font = 'bold 32px -apple-system';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ä—à—Ä—É—Ç–µ', this.canvas.width / 2, this.canvas.height / 2);
            }
            
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            formatDistance(meters) {
                if (!meters) return '‚Äî';
                if (meters >= 1000) {
                    return `${(meters / 1000).toFixed(1)} km`;
                }
                return `${meters} m`;
            }
            
            formatElevation(meters) {
                if (!meters) return '‚Äî';
                return `${meters} m`;
            }
            
            formatTime(seconds) {
                if (!seconds) return '‚Äî';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            }
            
            formatSpeed(mps) {
                if (!mps) return '‚Äî';
                const kmh = mps * 3.6;
                return `${kmh.toFixed(1)} km/h`;
            }
            
            showError(message) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error-text').textContent = message;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            new ActivityViewer();
        });
    </script>
</body>
</html>
